#!/bin/bash
# {{ ansible_managed }}

# Envoy startup script with hot restart support
# This script is called by hot-restarter.py

set -e

# Envoy binary path (installed via APT)
ENVOY_BIN="/usr/bin/envoy"

# Configuration file
CONFIG_FILE="/etc/envoy/envoy.yaml"

# Hot restart parameters
BASE_ID=1
PARENT_SHUTDOWN_TIME=15

# Restart epoch (can be overridden by hot-restarter.py)
RESTART_EPOCH="${RESTART_EPOCH:-0}"

# Check if Envoy binary exists
if [ ! -f "$ENVOY_BIN" ]; then
    echo "Error: Envoy binary not found at $ENVOY_BIN"
    exit 1
fi

# Check if config file exists
if [ ! -f "$CONFIG_FILE" ]; then
    echo "Error: Envoy config file not found at $CONFIG_FILE"
    exit 1
fi

# Start Envoy with hot restart parameters
exec "$ENVOY_BIN" \
    --base-id "$BASE_ID" \
    --restart-epoch "$RESTART_EPOCH" \
    --parent-shutdown-time-s "$PARENT_SHUTDOWN_TIME" \
    --config-path "$CONFIG_FILE" 
