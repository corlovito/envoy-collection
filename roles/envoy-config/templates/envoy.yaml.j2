# {{ ansible_managed }}

admin:
  address:
    socket_address:
      address: {{ envoy_admin_host | default('0.0.0.0') }}
      port_value: {{ envoy_admin_port | default(9901) }}
  {% if envoy_admin_access_log_path is defined %}
  access_log_path: {{ envoy_admin_access_log_path }}
  {% endif %}
  {% if envoy_admin_profile_path is defined %}
  profile_path: {{ envoy_admin_profile_path }}
  {% endif %}

static_resources:
  listeners:
  {% for listener in envoy_listeners %}
    - name: {{ listener.name }}
      address:
        socket_address:
          address: {{ listener.address | default('0.0.0.0') }}
          port_value: {{ listener.port }}
      {% if listener.filter_chains is defined %}
      filter_chains:
      {% for filter_chain in listener.filter_chains %}
        - filters:
        {% for filter in filter_chain.filters %}
          - name: {{ filter.name }}
            {% if filter.typed_config is defined %}
            typed_config:
              "@type": {{ filter.typed_config.type }}
              {% for key, value in filter.typed_config.config.items() %}
              {{ key }}: {{ value | to_json if value is mapping or value is sequence else value }}
              {% endfor %}
            {% endif %}
        {% endfor %}
      {% endfor %}
      {% else %}
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: {{ listener.stat_prefix | default('ingress_http') }}
                codec_type: AUTO
                route_config:
                  name: {{ listener.route_config_name | default('local_route') }}
                  virtual_hosts:
                    - name: {{ listener.virtual_host_name | default('local_service') }}
                      domains: {{ listener.domains | default(['*']) | to_json }}
                      routes:
                        - match:
                            prefix: {{ listener.route_prefix | default('/') }}
                          route:
                            cluster: {{ listener.cluster | default('example_service') }}
                http_filters:
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
      {% endif %}
  {% endfor %}

  clusters:
  {% for cluster in envoy_clusters %}
    - name: {{ cluster.name }}
      connect_timeout: {{ cluster.connect_timeout | default('0.25s') }}
      type: {{ cluster.type | default('STATIC') }}
      lb_policy: {{ cluster.lb_policy | default('ROUND_ROBIN') }}
      {% if cluster.health_checks is defined %}
      health_checks:
      {% for health_check in cluster.health_checks %}
        - timeout: {{ health_check.timeout | default('1s') }}
          interval: {{ health_check.interval | default('10s') }}
          interval_jitter: {{ health_check.interval_jitter | default('1s') }}
          unhealthy_threshold: {{ health_check.unhealthy_threshold | default(1) }}
          healthy_threshold: {{ health_check.healthy_threshold | default(1) }}
          http_health_check:
            path: {{ health_check.path | default('/health') }}
      {% endfor %}
      {% endif %}
      load_assignment:
        cluster_name: {{ cluster.name }}
        endpoints:
          - lb_endpoints:
            {% for endpoint in cluster.endpoints %}
              - endpoint:
                  address:
                    socket_address:
                      address: {{ endpoint.address }}
                      port_value: {{ endpoint.port }}
                  {% if endpoint.health_check_config is defined %}
                  health_check_config:
                    port_value: {{ endpoint.health_check_config.port | default(endpoint.port) }}
                  {% endif %}
            {% endfor %}
  {% endfor %}

{% if envoy_secrets is defined %}
  secrets:
  {% for secret in envoy_secrets %}
    - name: {{ secret.name }}
      {% if secret.tls_certificate is defined %}
      tls_certificate:
        certificate_chain:
          filename: {{ secret.tls_certificate.certificate_chain }}
        private_key:
          filename: {{ secret.tls_certificate.private_key }}
      {% endif %}
  {% endfor %}
{% endif %}

{% if envoy_runtime is defined %}
runtime:
  symlink_root: {{ envoy_runtime.symlink_root | default('/etc/envoy/runtime') }}
  subdirectory: {{ envoy_runtime.subdirectory | default('') }}
  override_subdirectory: {{ envoy_runtime.override_subdirectory | default('') }}
{% endif %} 